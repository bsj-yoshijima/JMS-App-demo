<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Japan Mobility Show - ãƒã‚±ãƒƒãƒˆã‚·ã‚¹ãƒ†ãƒ </title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsbarcode/3.11.5/JsBarcode.all.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <style>
         :root {
            --brand-blue: #1E40AF;
            --brand-red: #dc2626;
            --brand-gradient: linear-gradient(135deg, var(--brand-blue), var(--brand-red));
        }
        
        body {
            background: #f8fafc;
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        
        .page {
            max-width: 100%;
            min-height: 100vh;
            transition: transform 0.3s ease-out;
        }
        
        .page.active {
            transform: translateX(0);
        }
        
        .page.inactive {
            transform: translateX(100%);
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
        }
        
        .btn {
            padding: 16px 24px;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .btn-primary {
            background: var(--brand-gradient);
            color: white;
            box-shadow: 0 4px 12px rgba(30, 64, 175, 0.2);
        }
        
        .btn-secondary {
            background: white;
            color: var(--brand-blue);
            border: 2px solid #e2e8f0;
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        .card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
            padding: 24px;
            margin: 16px;
            transition: all 0.3s ease;
        }
        
        .ticket-card {
            border-left: 4px solid var(--brand-blue);
            cursor: pointer;
        }
        
        .ticket-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.12);
        }
        
        .header {
            position: relative;
            padding: 24px;
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .back-btn {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            padding: 8px;
            border-radius: 8px;
            color: #64748b;
        }
        
        select {
            appearance: none;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 12px 16px;
            width: 100%;
            margin: 8px 0;
            font-size: 16px;
            transition: all 0.2s ease;
        }
        
        select:focus {
            border-color: var(--brand-blue);
            outline: none;
            box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
        }
        
        .qr-preview {
            width: 100%;
            max-width: 300px;
            margin: 0 auto;
            padding: 20px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
        
        #reader {
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }
        
        .floating-action-btn {
            position: fixed;
            bottom: 32px;
            right: 32px;
            width: 64px;
            height: 64px;
            border-radius: 32px;
            background: var(--brand-gradient);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(30, 64, 175, 0.3);
            transition: all 0.3s ease;
        }
        
        .floating-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(30, 64, 175, 0.4);
        }
        
        .scan-option {
            display: flex;
            align-items: center;
            padding: 24px;
            margin: 16px 0;
            border-radius: 24px;
            background: white;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.06);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .scan-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 28px rgba(0, 0, 0, 0.1);
            background: linear-gradient(145deg, white, #f8fafc);
        }
        
        .scan-option:active {
            transform: translateY(0);
        }
        
        .icon {
            width: 48px;
            height: 48px;
            margin-right: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(145deg, #f1f5f9, #f8fafc);
            border-radius: 16px;
            font-size: 24px;
        }
        
        .scan-option-content {
            flex: 1;
        }
        
        .scan-option-title {
            font-size: 18px;
            font-weight: 700;
            color: #1a237e;
            margin-bottom: 4px;
        }
        
        .scan-option-description {
            font-size: 14px;
            color: #64748b;
        }
        
        .tickets-button {
            margin-top: 32px;
            background: white;
            border: 2px solid #e2e8f0;
            padding: 20px;
            border-radius: 20px;
            width: 100%;
            font-weight: 600;
            color: #1a237e;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        
        .tickets-button:hover {
            border-color: #1a237e;
            background: #f8fafc;
        }
    </style>
</head>

<body>
    <!-- ã‚¹ã‚­ãƒ£ãƒ³ã‚ªãƒ—ã‚·ãƒ§ãƒ³é¸æŠç”»é¢ -->
    <div id="scan-options-page" class="page active">
        <div class="header">
            <h1 class="text-xl font-bold text-center">ãƒã‚±ãƒƒãƒˆã‚¹ã‚­ãƒ£ãƒ³</h1>
        </div>
        <div class="container mx-auto px-4 py-8">
            <div class="mb-8">
                <button onclick="showImagePicker()" class="scan-option w-full">
                    <div class="icon">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#1a237e" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                            <circle cx="8.5" cy="8.5" r="1.5"/>
                            <polyline points="21 15 16 10 5 21"/>
                        </svg>
                    </div>
                    <div class="scan-option-content">
                        <div class="scan-option-title">ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‹ã‚‰é¸ã¶</div>
                        <div class="scan-option-description">ä¿å­˜ã•ã‚ŒãŸç”»åƒã‹ã‚‰QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚‹</div>
                    </div>
                </button>
                <button onclick="startCameraScan()" class="scan-option w-full">
                    <div class="icon">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#1a237e" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                            <circle cx="12" cy="13" r="4"/>
                        </svg>
                    </div>
                    <div class="scan-option-content">
                        <div class="scan-option-title">ã‚«ãƒ¡ãƒ©ã§ã‚¹ã‚­ãƒ£ãƒ³</div>
                        <div class="scan-option-description">ã‚«ãƒ¡ãƒ©ã‚’ä½¿ç”¨ã—ã¦QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³</div>
                    </div>
                </button>
                <button onclick="showGeminiCameraModal()" class="scan-option w-full">
                    <div class="icon">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#dc2626" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M8 12h8M12 8v8"/>
                        </svg>
                    </div>
                    <div class="scan-option-content">
                        <div class="scan-option-title">Geminiã§ãƒãƒ¼ã‚³ãƒ¼ãƒ‰è§£æ</div>
                        <div class="scan-option-description">ã‚«ãƒ¡ãƒ©ã§æ’®å½±ã—Geminiã§è§£æ</div>
                    </div>
                </button>
            </div>
            <button onclick="showTicketList()" class="tickets-button">
                ãƒã‚±ãƒƒãƒˆä¸€è¦§ã‚’è¦‹ã‚‹
            </button>
        </div>
    </div>

    <!-- ã‚«ãƒ¡ãƒ©ã‚¹ã‚­ãƒ£ãƒ³ç”»é¢ -->
    <div id="camera-scan-page" class="page inactive">
        <div class="header">
            <button onclick="showScanOptions()" class="back-btn">â†</button>
            <h1 class="text-xl font-bold text-center">QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³</h1>
        </div>
        <div class="container mx-auto px-4 py-8">
            <div class="scan-container">
                <div class="phone-guide">
                    <svg class="phone-icon" width="120" height="120" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <rect x="5" y="2" width="14" height="20" rx="3" stroke="#1a237e"/>
                        <path d="M12 18h.01" stroke="#1a237e"/>
                        <rect x="8" y="5" width="8" height="11" stroke="#1a237e"/>
                    </svg>
                    <div class="qr-scanner-animation"></div>
                </div>
                <p class="scan-text">QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚Šã‚¨ãƒªã‚¢ã«åˆã‚ã›ã¦ãã ã•ã„</p>
                <div id="reader"></div>
            </div>
            <style>
                .scan-container {
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    min-height: 70vh;
                    position: relative;
                }
                
                .phone-guide {
                    position: relative;
                    margin-bottom: 24px;
                }
                
                .phone-icon {
                    opacity: 0.8;
                }
                
                .qr-scanner-animation {
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    width: 40px;
                    height: 40px;
                    background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24' height='24'%3E%3Cpath fill='none' stroke='%231a237e' stroke-width='2' d='M4 4h4v4H4zM16 4h4v4h-4zM4 16h4v4H4zM16 16h4v4h-4z'/%3E%3C/svg%3E") no-repeat center;
                    animation: scanAnimation 2s infinite;
                }
                
                .bg-white.rounded-2xl.w-\[calc\(100\%-48px\)\].max-w-sm.mx-auto.p-6.transform.transition-all {
                    margin-top: 0px !important;
                    margin-left: 65px;
                }
                
                @keyframes scanAnimation {
                    0% {
                        opacity: 0;
                        transform: translate(-50%, -60%) scale(0.8);
                    }
                    50% {
                        opacity: 1;
                        transform: translate(-50%, -50%) scale(1.2);
                    }
                    100% {
                        opacity: 0;
                        transform: translate(-50%, -40%) scale(0.8);
                    }
                }
                
                .scan-text {
                    color: #1a237e;
                    font-size: 16px;
                    font-weight: 500;
                    margin: 16px 0;
                    text-align: center;
                }
                
                #reader {
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    opacity: 0.8;
                }
                
                #reader video {
                    border-radius: 16px;
                }
                
                .html5-qrcode-element {
                    border-radius: 12px !important;
                }
            </style>
        </div>
    </div>

    <!-- ãƒã‚±ãƒƒãƒˆç™»éŒ²ç”»é¢ -->
    <div id="ticket-register-page" class="page inactive">
        <div class="header">
            <button onclick="showScanOptions()" class="back-btn">â†</button>
            <h1 class="text-xl font-bold text-center">ãƒã‚±ãƒƒãƒˆç™»éŒ²</h1>
        </div>
        <div class="container mx-auto px-4 py-8">
            <div class="qr-preview mb-8">
                <!-- QRã‚³ãƒ¼ãƒ‰ç”¨ -->
                <div id="qrcode" class="flex justify-center"></div>
                <!-- ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ç”¨ -->
                <svg id="barcode" class="w-full max-w-[300px] mx-auto hidden"></svg>
            </div>
            <div class="card">
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ãƒã‚±ãƒƒãƒˆç¨®åˆ¥</label>
                    <select id="ticket-type" class="w-full">
                        <option value="general">ä¸€èˆ¬å…¥å ´åˆ¸</option>
                        <option value="vip">VIPãƒã‚±ãƒƒãƒˆ</option>
                        <option value="press">ãƒ—ãƒ¬ã‚¹é–¢ä¿‚è€…</option>
                        <option value="exhibitor">å‡ºå±•è€…ãƒ‘ã‚¹</option>
                    </select>
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">å…¥å ´æ—¥æ™‚</label>
                    <select id="ticket-date" class="w-full mb-2">
                        <option value="2024-10-24">2024å¹´10æœˆ24æ—¥ï¼ˆæœ¨ï¼‰</option>
                        <option value="2024-10-25">2024å¹´10æœˆ25æ—¥ï¼ˆé‡‘ï¼‰</option>
                        <option value="2024-10-26">2024å¹´10æœˆ26æ—¥ï¼ˆåœŸï¼‰</option>
                        <option value="2024-10-27">2024å¹´10æœˆ27æ—¥ï¼ˆæ—¥ï¼‰</option>
                    </select>
                    <select id="ticket-time" class="w-full">
                        <option value="1000">10:00å…¥å ´</option>
                        <option value="1300">13:00å…¥å ´</option>
                        <option value="1500">15:00å…¥å ´</option>
                    </select>
                </div>

                <p class="text-red-600 text-sm mb-4 font-medium">
                    â€» èª¤ã£ãŸæ—¥ä»˜ã‚„æ™‚é–“ã‚’æŒ‡å®šã•ã‚ŒãŸå ´åˆã§ã‚‚ã€ä¸€åˆ‡è²¬ä»»ã‚’è² ã„ã¾ã›ã‚“ã€‚
                </p>


                <button onclick="saveTicket()" class="btn btn-primary w-full">
                    ç™»éŒ²ã™ã‚‹
                </button>
            </div>
        </div>
    </div>

    <!-- ãƒã‚±ãƒƒãƒˆä¸€è¦§ç”»é¢ -->
    <div id="ticket-list-page" class="page inactive">
        <div class="header">
            <button onclick="showScanOptions()" class="back-btn">â†</button>
            <h1 class="text-xl font-bold text-center">ãƒã‚±ãƒƒãƒˆä¸€è¦§</h1>
        </div>
        <div class="container mx-auto px-4 py-8">
            <div id="ticket-list"></div>
        </div>
        <button onclick="showScanOptions()" class="floating-action-btn">
            ï¼‹
        </button>
    </div>

    <!-- ãƒã‚±ãƒƒãƒˆç·¨é›†ç”»é¢ -->
    <div id="ticket-edit-page" class="page inactive">
        <div class="header">
            <button onclick="showTicketList()" class="back-btn">â†</button>
            <h1 class="text-xl font-bold text-center">ãƒã‚±ãƒƒãƒˆç·¨é›†</h1>
        </div>
        <div class="container mx-auto px-4 py-8">
            <div class="qr-preview mb-8">
                <div id="edit-qrcode" class="flex justify-center"></div>
            </div>
            <div class="card">
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ãƒã‚±ãƒƒãƒˆç¨®åˆ¥</label>
                    <select id="edit-ticket-type" class="w-full">
                        <option value="general">ä¸€èˆ¬å…¥å ´åˆ¸</option>
                        <option value="vip">VIPãƒã‚±ãƒƒãƒˆ</option>
                        <option value="press">ãƒ—ãƒ¬ã‚¹é–¢ä¿‚è€…</option>
                        <option value="exhibitor">å‡ºå±•è€…ãƒ‘ã‚¹</option>
                    </select>
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">å…¥å ´æ—¥æ™‚</label>
                    <select id="edit-ticket-date" class="w-full mb-2">
                        <option value="2024-10-24">2024å¹´10æœˆ24æ—¥ï¼ˆæœ¨ï¼‰</option>
                        <option value="2024-10-25">2024å¹´10æœˆ25æ—¥ï¼ˆé‡‘ï¼‰</option>
                        <option value="2024-10-26">2024å¹´10æœˆ26æ—¥ï¼ˆåœŸï¼‰</option>
                        <option value="2024-10-27">2024å¹´10æœˆ27æ—¥ï¼ˆæ—¥ï¼‰</option>
                    </select>
                    <select id="edit-ticket-time" class="w-full">
                        <option value="1000">10:00å…¥å ´</option>
                        <option value="1300">13:00å…¥å ´</option>
                        <option value="1500">15:00å…¥å ´</option>
                    </select>
                </div>
                <div class="flex space-x-4">
                    <button onclick="updateTicket()" class="btn btn-primary flex-1">
                        æ›´æ–°ã™ã‚‹
                    </button>
                    <button onclick="deleteTicket()" class="btn btn-secondary flex-1">
                        å‰Šé™¤
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Geminiã‚«ãƒ¡ãƒ©ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="gemini-camera-modal" class="fixed inset-0 flex items-center justify-center z-50" style="background: rgba(0,0,0,0.5); display: none;">
        <div class="bg-white rounded-2xl p-6 max-w-sm w-full flex flex-col items-center">
            <video id="gemini-camera-video" autoplay playsinline class="rounded-lg w-full max-w-xs mb-4" style="background:#000;" width="320" height="240"></video>
            <canvas id="gemini-camera-canvas" style="display:none;"></canvas>
            <div class="flex w-full space-x-2">
                <button onclick="captureGeminiPhoto()" class="flex-1 bg-blue-600 text-white py-2 rounded-lg font-semibold">æ’®å½±</button>
                <button onclick="closeGeminiCameraModal()" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg font-semibold">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>

    <input type="file" id="file-input" accept="image/*" style="display: none" onchange="handleImageFile(this)">
    <input type="file" id="gemini-file-input" accept="image/*" style="display: none" onchange="handleGeminiImageFile(this)">

    <script>
        let currentQR = '';
        let editingTicketId = null;
        let html5QrcodeScanner = null;

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.add('inactive');
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.remove('inactive');
            document.getElementById(pageId).classList.add('active');
        }

        function showScanOptions() {
            if (html5QrcodeScanner) {
                html5QrcodeScanner.clear();
            }
            showPage('scan-options-page');
        }

        function showImagePicker() {
            document.getElementById('file-input').click();
        }

        function initializeImageFileInput() {
            const fileInput = document.getElementById('file-input');
            fileInput.value = '';
        }

        async function handleImageFile(input) {
            const file = input.files[0];
            try {
                const html5Qrcode = new Html5Qrcode("reader");
                const result = await html5Qrcode.scanFile(file, true); // ç¬¬2å¼•æ•°ã‚’trueã«ã—ã¦ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³ã‚’æœ‰åŠ¹åŒ–
                processBarcode(result); // processQRCode ã‹ã‚‰ processBarcode ã«å¤‰æ›´
            } catch (error) {
                alert('ã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚åˆ¥ã®ç”»åƒã‚’è©¦ã—ã¦ãã ã•ã„ã€‚');
                console.error(error);
            } finally {
                // å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢ã—ã¦æ¬¡å›ã®èª­ã¿å–ã‚Šã«å‚™ãˆã‚‹
                input.value = '';
            }
        }

        function startCameraScan() {
            showPage('camera-scan-page');

            if (html5QrcodeScanner) {
                html5QrcodeScanner.clear();
            }

            navigator.mediaDevices.enumerateDevices()
                .then(devices => {
                    const cameras = devices.filter(device => device.kind === 'videoinput');
                    const rearCamera = cameras[0];

                    if (rearCamera) {
                        const html5Qrcode = new Html5Qrcode("reader");
                        const config = {
                            fps: 10,
                            qrbox: 250,
                            aspectRatio: 1.0,
                            formatsToSupport: [ // å¯¾å¿œãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’è¿½åŠ 
                                Html5QrcodeSupportedFormats.QR_CODE,
                                Html5QrcodeSupportedFormats.EAN_13,
                                Html5QrcodeSupportedFormats.CODE_128,
                                Html5QrcodeSupportedFormats.CODE_39,
                                Html5QrcodeSupportedFormats.UPC_A,
                                Html5QrcodeSupportedFormats.UPC_E,
                                Html5QrcodeSupportedFormats.EAN_8
                            ],
                            videoConstraints: {
                                deviceId: rearCamera.deviceId,
                                facingMode: "environment",
                                width: {
                                    min: 640,
                                    ideal: 1280,
                                    max: 1920
                                },
                                height: {
                                    min: 480,
                                    ideal: 720,
                                    max: 1080
                                }
                            }
                        };

                        html5Qrcode.start(
                            rearCamera.deviceId,
                            config,
                            (decodedText) => {
                                html5Qrcode.stop().then(() => {
                                    processBarcode(decodedText);
                                });
                            },
                            (errorMessage) => {
                                // QRã‚³ãƒ¼ãƒ‰/ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚‰ãªã„æ™‚ã¯ä½•ã‚‚ã—ãªã„
                            }
                        ).catch((err) => {
                            console.error("ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ:", err);
                            alert('ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                            showScanOptions();
                        });
                    } else {
                        alert('ã‚«ãƒ¡ãƒ©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
                        showScanOptions();
                    }
                })
                .catch(error => {
                    console.error("ãƒ‡ãƒã‚¤ã‚¹ã®åˆ—æŒ™ã«å¤±æ•—:", error);
                    alert('ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
                    showScanOptions();
                });
        }

        function processBarcode(barcodeData) {
            // QRã‚³ãƒ¼ãƒ‰ã®å ´åˆï¼ˆ13æ¡ã®è‹±æ•°å­—ï¼‰
            const isQRTicket = /^[A-Za-z0-9]{13}$/.test(barcodeData);

            // JANã‚³ãƒ¼ãƒ‰ï¼ˆ13æ¡ã®æ•°å­—ï¼‰
            const isJAN = /^\d{13}$/.test(barcodeData);

            // ãã®ä»–ã®ä¸€æ¬¡å…ƒãƒãƒ¼ã‚³ãƒ¼ãƒ‰ï¼ˆCODE128, CODE39ãªã©ï¼‰
            const isOtherBarcode = /^[A-Za-z0-9-_]{1,}$/.test(barcodeData);

            if (isQRTicket || isJAN || isOtherBarcode) {
                currentQR = barcodeData;
                showTicketRegister();
            } else {
                showErrorDialog('å¯¾å¿œã—ã¦ã„ãªã„ãƒãƒ¼ã‚³ãƒ¼ãƒ‰å½¢å¼ã§ã™');
            }
        }

        function showErrorDialog(message) {
            const dialogHtml = `
                <div class="fixed inset-0 flex items-center justify-center z-50" style="background: rgba(0, 0, 0, 0.5);">
                    <div class="bg-white rounded-2xl w-[calc(100%-48px)] max-w-sm mx-auto p-6 transform transition-all">
                        <div class="text-center">
                            <h3 class="text-xl font-bold mb-4">ã‚¨ãƒ©ãƒ¼</h3>
                            <p class="text-gray-700 text-center mb-6">${message}</p>
                            <button onclick="closeErrorDialog()" 
                                    class="w-full bg-blue-600 text-white py-3 rounded-xl font-semibold">
                                é–‰ã˜ã‚‹
                            </button>
                        </div>
                    </div>
                </div>
            `;

            const dialogElement = document.createElement('div');
            dialogElement.id = 'error-dialog';
            dialogElement.innerHTML = dialogHtml;
            document.body.appendChild(dialogElement);

            // ã‚¨ãƒ©ãƒ¼ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤ºã—ãŸå¾Œã€ã‚¹ã‚­ãƒ£ãƒ³ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹
            setTimeout(() => {
                showScanOptions();
            }, 100);
        }

        // ãƒãƒ¼ã‚³ãƒ¼ãƒ‰è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        function updateBarcodeDisplay(barcodeData) {
            const qrcodeElement = document.getElementById('qrcode');
            const barcodeElement = document.getElementById('barcode');
            const type = detectBarcodeType(barcodeData);

            // æ—¢å­˜ã®è¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢
            qrcodeElement.innerHTML = '';
            barcodeElement.innerHTML = '';

            if (type === 'qr') {
                // QRã‚³ãƒ¼ãƒ‰ã®å ´åˆ
                qrcodeElement.classList.remove('hidden');
                barcodeElement.classList.add('hidden');
                new QRCode(qrcodeElement, {
                    text: barcodeData,
                    width: 200,
                    height: 200
                });
            } else {
                // ä¸€æ¬¡å…ƒãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã®å ´åˆ
                qrcodeElement.classList.add('hidden');
                barcodeElement.classList.remove('hidden');
                try {
                    JsBarcode("#barcode", barcodeData, {
                        format: type,
                        width: 2,
                        height: 100,
                        displayValue: true,
                        fontSize: 16,
                        margin: 10
                    });
                } catch (e) {
                    // ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯CODE128ã§è¡¨ç¤ºã‚’è©¦ã¿ã‚‹
                    JsBarcode("#barcode", barcodeData, {
                        format: "code128",
                        width: 2,
                        height: 100,
                        displayValue: true,
                        fontSize: 16,
                        margin: 10
                    });
                }
            }
        }

        // ãƒã‚±ãƒƒãƒˆç™»éŒ²ç”»é¢è¡¨ç¤ºæ™‚ã®å‡¦ç†ã‚’æ›´æ–°
        function showTicketRegister() {
            showPage('ticket-register-page');
            updateBarcodeDisplay(currentQR);
        }

        // åŒæ§˜ã«ãƒã‚±ãƒƒãƒˆç·¨é›†ç”»é¢ã‚‚æ›´æ–°
        function showTicketEdit(ticketId) {
            editingTicketId = ticketId;
            const tickets = JSON.parse(localStorage.getItem('tickets') || '[]');
            const ticket = tickets.find(t => t.id === ticketId);

            if (!ticket) return;

            document.getElementById('edit-ticket-type').value = ticket.type;
            document.getElementById('edit-ticket-date').value = ticket.date;
            document.getElementById('edit-ticket-time').value = ticket.time;

            // ãƒãƒ¼ã‚³ãƒ¼ãƒ‰è¡¨ç¤ºã‚’æ›´æ–°
            const editQrcodeElement = document.getElementById('edit-qrcode');
            const editBarcodeElement = document.getElementById('edit-barcode');
            editQrcodeElement.innerHTML = '';

            if (detectBarcodeType(ticket.qr) === 'qr') {
                editQrcodeElement.classList.remove('hidden');
                editBarcodeElement.classList.add('hidden');
                new QRCode(editQrcodeElement, {
                    text: ticket.qr,
                    width: 200,
                    height: 200
                });
            } else {
                editQrcodeElement.classList.add('hidden');
                editBarcodeElement.classList.remove('hidden');
                JsBarcode("#edit-barcode", ticket.qr, {
                    format: detectBarcodeType(ticket.qr),
                    width: 2,
                    height: 100,
                    displayValue: true,
                    fontSize: 16,
                    margin: 10
                });
            }

            showPage('ticket-edit-page');
        }

        function closeErrorDialog() {
            const dialog = document.getElementById('error-dialog');
            if (dialog) {
                // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                dialog.style.opacity = '0';
                dialog.style.transition = 'opacity 0.2s ease-out';

                setTimeout(() => {
                    dialog.remove();
                }, 200);
            }
        }

        function showTicketRegister() {
            showPage('ticket-register-page');
            document.getElementById('qrcode').innerHTML = '';
            new QRCode(document.getElementById("qrcode"), {
                text: currentQR,
                width: 200,
                height: 200
            });
            updateBarcodeInfo(currentQR); // ãƒãƒ¼ã‚³ãƒ¼ãƒ‰æƒ…å ±ã‚’æ›´æ–°
        }

        function showTicketList() {
            showPage('ticket-list-page');
            renderTicketList();
        }

        function saveTicket() {
            const ticketType = document.getElementById('ticket-type').value;
            const date = document.getElementById('ticket-date').value;
            const time = document.getElementById('ticket-time').value;

            const ticket = {
                id: Date.now().toString(),
                qr: currentQR,
                type: ticketType,
                date: date,
                time: time,
                created: new Date().toISOString()
            };

            let tickets = JSON.parse(localStorage.getItem('tickets') || '[]');
            tickets.push(ticket);
            localStorage.setItem('tickets', JSON.stringify(tickets));

            showTicketList();
        }

        function renderTicketList() {
            const tickets = JSON.parse(localStorage.getItem('tickets') || '[]');
            const listElement = document.getElementById('ticket-list');

            listElement.innerHTML = tickets.map(ticket => `
            <div class="mb-6">
    <label class="block text-sm font-bold text-gray-700 mb-2">ãƒãƒ¼ã‚³ãƒ¼ãƒ‰æƒ…å ±</label>
    <div class="p-3 bg-gray-50 rounded-lg">
        <p class="text-sm text-gray-600" id="barcode-info"></p>
    </div>
</div>
                <div class="card ticket-card fade-in" onclick="showTicketEdit('${ticket.id}')">
                    <div class="flex justify-between items-center">
                        <div>
                            <div class="font-bold text-lg">${getTicketTypeName(ticket.type)}</div>
                            <div class="text-gray-600">${formatDateTime(ticket.date, ticket.time)}</div>
                        </div>
                        <div class="text-2xl">â†’</div>
                    </div>
                </div>
            `).join('');
        }

        function showTicketEdit(ticketId) {
            editingTicketId = ticketId;
            const tickets = JSON.parse(localStorage.getItem('tickets') || '[]');
            const ticket = tickets.find(t => t.id === ticketId);

            if (!ticket) return;

            document.getElementById('edit-ticket-type').value = ticket.type;
            document.getElementById('edit-ticket-date').value = ticket.date;
            document.getElementById('edit-ticket-time').value = ticket.time;

            document.getElementById('edit-qrcode').innerHTML = '';
            new QRCode(document.getElementById("edit-qrcode"), {
                text: ticket.qr,
                width: 200,
                height: 200
            });

            showPage('ticket-edit-page');
        }

        function updateTicket() {
            if (!editingTicketId) return;

            const tickets = JSON.parse(localStorage.getItem('tickets') || '[]');
            const ticketIndex = tickets.findIndex(t => t.id === editingTicketId);

            if (ticketIndex === -1) return;

            tickets[ticketIndex] = {
                ...tickets[ticketIndex],
                type: document.getElementById('edit-ticket-type').value,
                date: document.getElementById('edit-ticket-date').value,
                time: document.getElementById('edit-ticket-time').value,
                updated: new Date().toISOString()
            };

            localStorage.setItem('tickets', JSON.stringify(tickets));
            showTicketList();
        }

        function deleteTicket() {
            if (!editingTicketId) return;

            if (confirm('ã“ã®ãƒã‚±ãƒƒãƒˆã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
                const tickets = JSON.parse(localStorage.getItem('tickets') || '[]');
                const filteredTickets = tickets.filter(t => t.id !== editingTicketId);
                localStorage.setItem('tickets', JSON.stringify(filteredTickets));
                showTicketList();
            }
        }

        function getTicketTypeName(type) {
            const types = {
                general: 'ä¸€èˆ¬å…¥å ´åˆ¸',
                vip: 'VIPãƒã‚±ãƒƒãƒˆ',
                press: 'ãƒ—ãƒ¬ã‚¹é–¢ä¿‚è€…',
                exhibitor: 'å‡ºå±•è€…ãƒ‘ã‚¹'
            };
            return types[type] || type;
        }

        function formatDateTime(date, time) {
            const dateObj = new Date(date);
            const days = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            const formattedDate = `${dateObj.getFullYear()}å¹´${dateObj.getMonth() + 1}æœˆ${dateObj.getDate()}æ—¥(${days[dateObj.getDay()]})`;
            const formattedTime = `${time.substring(0, 2)}:${time.substring(2)}`;
            return `${formattedDate} ${formattedTime}å…¥å ´`;
        }

        // åˆæœŸè¡¨ç¤º
        showScanOptions();

        // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã®åˆæœŸåŒ–
        initializeImageFileInput();

        // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®åˆæœŸåŒ–
        window.onerror = function(message, source, lineno, colno, error) {
            console.error('Global error:', error);
            alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
            showScanOptions();
            return true;
        };

        // ãƒšãƒ¼ã‚¸é·ç§»æ™‚ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        window.onbeforeunload = function() {
            if (html5QrcodeScanner) {
                html5QrcodeScanner.clear();
            }
        };

        // ã‚¹ãƒ¯ã‚¤ãƒ—ã§ã®æˆ»ã‚‹æ“ä½œã®å®Ÿè£…
        document.addEventListener('touchstart', handleTouchStart, false);
        document.addEventListener('touchmove', handleTouchMove, false);

        let xDown = null;
        let yDown = null;

        function handleTouchStart(evt) {
            const firstTouch = evt.touches[0];
            xDown = firstTouch.clientX;
            yDown = firstTouch.clientY;
        }

        function handleTouchMove(evt) {
            if (!xDown || !yDown) {
                return;
            }

            const xUp = evt.touches[0].clientX;
            const yUp = evt.touches[0].clientY;

            const xDiff = xDown - xUp;
            const yDiff = yDown - yUp;

            if (Math.abs(xDiff) > Math.abs(yDiff)) {
                if (xDiff > 0) {
                    /* å·¦ã‚¹ãƒ¯ã‚¤ãƒ— */
                } else {
                    /* å³ã‚¹ãƒ¯ã‚¤ãƒ— - æˆ»ã‚‹ */
                    const currentPage = document.querySelector('.page.active');
                    if (currentPage.id !== 'scan-options-page') {
                        if (currentPage.id === 'ticket-list-page') {
                            showScanOptions();
                        } else if (currentPage.id === 'ticket-edit-page') {
                            showTicketList();
                        } else {
                            showScanOptions();
                        }
                    }
                }
            }

            xDown = null;
            yDown = null;
        }

        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            showScanOptions();
            initializeImageFileInput();
        });

        // Geminiã‚«ãƒ¡ãƒ©ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
        function showGeminiCameraModal() {
            const modal = document.getElementById('gemini-camera-modal');
            modal.style.display = 'flex';
            const video = document.getElementById('gemini-camera-video');
            // ã‚«ãƒ¡ãƒ©èµ·å‹•
            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                .then(stream => {
                    video.srcObject = stream;
                })
                .catch(err => {
                    showErrorDialog('ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message);
                    closeGeminiCameraModal();
                });
        }
        // ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã‚‹ï¼‹ã‚«ãƒ¡ãƒ©åœæ­¢
        function closeGeminiCameraModal() {
            const modal = document.getElementById('gemini-camera-modal');
            modal.style.display = 'none';
            const video = document.getElementById('gemini-camera-video');
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }
        }
        // æ’®å½±â†’Geminié€ä¿¡
        async function captureGeminiPhoto() {
            const video = document.getElementById('gemini-camera-video');
            const canvas = document.getElementById('gemini-camera-canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            // ç”»åƒBase64å–å¾—
            const base64 = canvas.toDataURL('image/jpeg').split(',')[1];
            closeGeminiCameraModal();
            try {
                showGeminiLoading();
                const result = await analyzeBarcodeWithGemini(base64);
                hideGeminiLoading();
                showGeminiResultDialog(result);
            } catch (error) {
                hideGeminiLoading();
                showErrorDialog('Geminiè§£æã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error.message || error));
            }
        }

        // Geminiãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º/éè¡¨ç¤º
        function showGeminiLoading() {
            if (document.getElementById('gemini-loading')) return;
            const loading = document.createElement('div');
            loading.id = 'gemini-loading';
            loading.innerHTML = `<div class="fixed inset-0 flex items-center justify-center z-50" style="background: rgba(0,0,0,0.4);"><div class="bg-white rounded-2xl p-8 text-center"><div class="mb-4 animate-spin text-4xl">ğŸ”„</div><div>Geminiã§è§£æä¸­...</div></div></div>`;
            document.body.appendChild(loading);
        }
        function hideGeminiLoading() {
            const loading = document.getElementById('gemini-loading');
            if (loading) loading.remove();
        }

        // Gemini APIå‘¼ã³å‡ºã—
        async function analyzeBarcodeWithGemini(base64Image) {
    const endpoint = 'https://zgjdsu2h55mixnskwekldqyuwm0cjqkz.lambda-url.ap-northeast-1.on.aws/';
    const requestData = {
        action: 'analyze',
        image: base64Image,
        generateEventosQR: true  // Eventos QRã‚³ãƒ¼ãƒ‰ã‚‚ç”Ÿæˆã™ã‚‹ãƒ•ãƒ©ã‚°
    };
    const response = await fetch(endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(requestData)
    });
    if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Gemini APIã‚¨ãƒ©ãƒ¼');
    }
    const data = await response.json();
    
    // Eventos QRã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
    if (data.result && !data.eventosQR) {
        data.eventosQR = generateClientSideEventosQR(data.result);
    }
    
    return data;
}

function generateClientSideEventosQR(extractedCode) {
    const eventosData = {
        event_id: '359853',
        ticket_id: Date.now().toString(),
        purchased_ticket_id: Date.now().toString(),
        qr_code: extractedCode,
        type: 'general',
        date: '2024-10-24',
        time: '1000',
        timestamp: new Date().toISOString()
    };
    return JSON.stringify(eventosData);
}

function showGeminiResultDialog(result) {
    let extractedText = '';
    let isValidCode = false;
    let eventosQR = null;
    
    // Geminiã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡º
    if (result && result.rawResponse && result.rawResponse.candidates && result.rawResponse.candidates[0]) {
        const candidate = result.rawResponse.candidates[0];
        if (candidate.content && candidate.content.parts && candidate.content.parts[0]) {
            extractedText = candidate.content.parts[0].text.trim();
        }
    } else if (result && result.result) {
        extractedText = result.result.trim();
    } else if (typeof result === 'string') {
        extractedText = result.trim();
    }

    // Eventos QRãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯å–å¾—
    if (result && result.eventosQR) {
        eventosQR = result.eventosQR;
    }

    // ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã®ç¨®é¡ã‚’åˆ¤å®š
    let codeType = 'ãƒ†ã‚­ã‚¹ãƒˆ';
    if (/^[A-Za-z0-9]{13}$/.test(extractedText)) {
        codeType = 'QRã‚³ãƒ¼ãƒ‰';
        isValidCode = true;
    } else if (/^\d{13}$/.test(extractedText)) {
        codeType = 'JANã‚³ãƒ¼ãƒ‰';
        isValidCode = true;
    } else if (/^[A-Za-z0-9-_]{8,}$/.test(extractedText)) {
        codeType = 'ãƒãƒ¼ã‚³ãƒ¼ãƒ‰';
        isValidCode = true;
    }

    // æœ‰åŠ¹ãªã‚³ãƒ¼ãƒ‰ã®å ´åˆã¯å¿…ãšEventos QRã‚³ãƒ¼ãƒ‰ã‚’è¡¨ç¤º
    if (isValidCode && !eventosQR) {
        eventosQR = generateClientSideEventosQR(extractedText);
    }

    const dialogHtml = `
        <div class="fixed inset-0 flex items-center justify-center z-50" style="background: rgba(0, 0, 0, 0.6);">
            <div class="bg-white rounded-2xl w-[calc(100%-32px)] max-w-md mx-auto p-6 transform transition-all shadow-2xl max-h-[90vh] overflow-y-auto">
                <div class="text-center">
                    <div class="mb-6">
                        <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-gradient-to-r from-blue-500 to-purple-600 flex items-center justify-center">
                            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M8 12h8M12 8v8"/>
                            </svg>
                        </div>
                        <h3 class="text-2xl font-bold text-gray-800">Geminiè§£æçµæœ</h3>
                    </div>
                    
                    <div class="mb-6 p-4 bg-gray-50 rounded-xl">
                        <div class="text-sm text-gray-600 mb-2">æ¤œå‡ºã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰</div>
                        <div class="text-lg font-bold text-gray-800 mb-2" style="word-break: break-all; font-family: monospace;">
                            ${extractedText || 'æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ'}
                        </div>
                        <div class="inline-block px-3 py-1 rounded-full text-sm font-semibold ${isValidCode ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                            ${codeType}
                        </div>
                    </div>

                    ${eventosQR ? `
                    <div class="mb-6 p-4 bg-blue-50 rounded-xl">
                        <div class="text-sm text-blue-600 mb-3 font-semibold">ç”Ÿæˆã•ã‚ŒãŸEventos QRã‚³ãƒ¼ãƒ‰</div>
                        <div id="gemini-result-qr" class="flex justify-center mb-3"></div>
                        <div class="text-xs text-blue-600 break-all">${eventosQR}</div>
                    </div>
                    ` : ''}

                    ${isValidCode ? `
                    <div class="mb-6">
                        <button onclick="registerFromGemini('${extractedText}')" class="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white py-3 rounded-xl font-semibold mb-3 hover:shadow-lg transition-all">
                            ã“ã®ã‚³ãƒ¼ãƒ‰ã§ãƒã‚±ãƒƒãƒˆç™»éŒ²
                        </button>
                        ${eventosQR ? `
                        <button onclick="registerWithEventos('${extractedText}')" class="w-full bg-gradient-to-r from-green-500 to-blue-600 text-white py-3 rounded-xl font-semibold mb-3 hover:shadow-lg transition-all">
                            Eventosã§ãƒã‚±ãƒƒãƒˆç™»éŒ²
                        </button>
                        ` : ''}
                    </div>
                    ` : ''}
                    
                    <button onclick="closeGeminiResultDialog()" class="w-full bg-gray-200 text-gray-700 py-3 rounded-xl font-semibold hover:bg-gray-300 transition-all">
                        é–‰ã˜ã‚‹
                    </button>
                </div>
            </div>
        </div>
    `;
    
    const dialogElement = document.createElement('div');
    dialogElement.id = 'gemini-result-dialog';
    dialogElement.innerHTML = dialogHtml;
    document.body.appendChild(dialogElement);

    // Eventos QRã‚³ãƒ¼ãƒ‰ã‚’è¡¨ç¤ºï¼ˆã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’èª¿æ•´ï¼‰
    if (eventosQR) {
        // DOMãŒç¢ºå®Ÿã«è¿½åŠ ã•ã‚Œã¦ã‹ã‚‰å®Ÿè¡Œ
        requestAnimationFrame(() => {
            const qrDisplay = document.getElementById('gemini-result-qr');
            if (qrDisplay) {
                try {
                    new QRCode(qrDisplay, {
                        text: eventosQR,
                        width: 120,
                        height: 120,
                        colorDark: "#000000",
                        colorLight: "#ffffff"
                    });
                } catch (error) {
                    console.error('QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
                    qrDisplay.innerHTML = '<div class="text-red-500">QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
                }
            }
        });
    }
}

        // Geminiè§£ææˆåŠŸæ™‚ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆEventos QRã‚³ãƒ¼ãƒ‰è¡¨ç¤ºï¼‰
        function showGeminiSuccessModal(extractedText, eventosQR) {
            const dialogHtml = `
                <div class="fixed inset-0 flex items-center justify-center z-50" style="background: rgba(0, 0, 0, 0.6);">
                    <div class="bg-white rounded-2xl w-[calc(100%-32px)] max-w-md mx-auto p-6 transform transition-all shadow-2xl">
                        <div class="text-center">
                            <div class="mb-6">
                                <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-green-500 flex items-center justify-center">
                                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="20,6 9,17 4,12"></polyline>
                                    </svg>
                                </div>
                                <h3 class="text-2xl font-bold text-gray-800">Geminiè§£ææˆåŠŸ</h3>
                            </div>
                            
                            <div class="mb-6 p-4 bg-green-50 rounded-xl">
                                <div class="text-sm text-green-600 mb-2">æ¤œå‡ºã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰</div>
                                <div class="text-lg font-bold text-gray-800 mb-2" style="word-break: break-all; font-family: monospace;">
                                    ${extractedText}
                                </div>
                                <div class="inline-block px-3 py-1 rounded-full text-sm font-semibold bg-green-100 text-green-800">
                                    ãƒãƒ¼ã‚³ãƒ¼ãƒ‰/QRã‚³ãƒ¼ãƒ‰
                                </div>
                            </div>

                            <div class="mb-6 p-4 bg-blue-50 rounded-xl">
                                <div class="text-sm text-blue-600 mb-3 font-semibold">ç”Ÿæˆã•ã‚ŒãŸEventos QRã‚³ãƒ¼ãƒ‰</div>
                                <div id="gemini-success-qr" class="flex justify-center mb-3"></div>
                                <div class="text-xs text-blue-600 break-all">${eventosQR}</div>
                            </div>
                            
                            <div class="mb-6">
                                <button onclick="registerFromGemini('${extractedText}')" class="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white py-3 rounded-xl font-semibold mb-3 hover:shadow-lg transition-all">
                                    ã“ã®ã‚³ãƒ¼ãƒ‰ã§ãƒã‚±ãƒƒãƒˆç™»éŒ²
                                </button>
                                <button onclick="registerWithEventos('${extractedText}')" class="w-full bg-gradient-to-r from-green-500 to-blue-600 text-white py-3 rounded-xl font-semibold mb-3 hover:shadow-lg transition-all">
                                    Eventosã§ãƒã‚±ãƒƒãƒˆç™»éŒ²
                                </button>
                            </div>
                            
                            <button onclick="closeGeminiSuccessModal()" class="w-full bg-gray-200 text-gray-700 py-3 rounded-xl font-semibold hover:bg-gray-300 transition-all">
                                é–‰ã˜ã‚‹
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            const dialogElement = document.createElement('div');
            dialogElement.id = 'gemini-success-modal';
            dialogElement.innerHTML = dialogHtml;
            document.body.appendChild(dialogElement);

            // Eventos QRã‚³ãƒ¼ãƒ‰ã‚’è¡¨ç¤º
            const qrDisplay = document.getElementById('gemini-success-qr');
            if (qrDisplay) {
                new QRCode(qrDisplay, {
                    text: eventosQR,
                    width: 120,
                    height: 120
                });
            }
        }

        function closeGeminiSuccessModal() {
            const dialog = document.getElementById('gemini-success-modal');
            if (dialog) dialog.remove();
        }

        function closeGeminiResultDialog() {
            const dialog = document.getElementById('gemini-result-dialog');
            if (dialog) dialog.remove();
        }

        // Eventos APIã§ãƒã‚±ãƒƒãƒˆç™»éŒ²
        async function registerWithEventos(qrCode) {
            try {
                showGeminiLoading();
                
                const ticketData = {
                    ticketId: Date.now().toString(),
                    purchasedTicketId: Date.now().toString(),
                    qrCode: qrCode,
                    type: 'general',
                    date: '2024-10-24',
                    time: '1000'
                };

                const endpoint = 'https://zgjdsu2h55mixnskwekldqyuwm0cjqkz.lambda-url.ap-northeast-1.on.aws/';
                const requestData = {
                    action: 'register',
                    ticketData: ticketData
                };

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Eventos APIã‚¨ãƒ©ãƒ¼');
                }

                const result = await response.json();
                hideGeminiLoading();
                
                // æˆåŠŸãƒ€ã‚¤ã‚¢ãƒ­ã‚°è¡¨ç¤º
                showEventosSuccessDialog(result);
                
            } catch (error) {
                hideGeminiLoading();
                showErrorDialog('Eventosç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error.message || error));
            }
        }

        // Eventosç™»éŒ²æˆåŠŸãƒ€ã‚¤ã‚¢ãƒ­ã‚°
        function showEventosSuccessDialog(result) {
            const dialogHtml = `
                <div class="fixed inset-0 flex items-center justify-center z-50" style="background: rgba(0, 0, 0, 0.6);">
                    <div class="bg-white rounded-2xl w-[calc(100%-32px)] max-w-md mx-auto p-6 transform transition-all shadow-2xl">
                        <div class="text-center">
                            <div class="mb-6">
                                <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-green-500 flex items-center justify-center">
                                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="20,6 9,17 4,12"></polyline>
                                    </svg>
                                </div>
                                <h3 class="text-2xl font-bold text-gray-800">Eventosç™»éŒ²å®Œäº†</h3>
                            </div>
                            
                            <div class="mb-6 p-4 bg-green-50 rounded-xl">
                                <div class="text-sm text-green-600 mb-2">ç™»éŒ²ã•ã‚ŒãŸãƒã‚±ãƒƒãƒˆ</div>
                                <div class="text-lg font-bold text-gray-800">${result.message || 'ç™»éŒ²å®Œäº†'}</div>
                            </div>

                            ${result.eventosQR ? `
                            <div class="mb-6 p-4 bg-blue-50 rounded-xl">
                                <div class="text-sm text-blue-600 mb-3 font-semibold">Eventos QRã‚³ãƒ¼ãƒ‰</div>
                                <div id="success-eventos-qr" class="flex justify-center mb-3"></div>
                                <div class="text-xs text-blue-600 break-all">${result.eventosQR}</div>
                            </div>
                            ` : ''}
                            
                            <button onclick="closeEventosSuccessDialog()" class="w-full bg-green-600 text-white py-3 rounded-xl font-semibold hover:bg-green-700 transition-all">
                                å®Œäº†
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            const dialogElement = document.createElement('div');
            dialogElement.id = 'eventos-success-dialog';
            dialogElement.innerHTML = dialogHtml;
            document.body.appendChild(dialogElement);

            // Eventos QRã‚³ãƒ¼ãƒ‰ã‚’è¡¨ç¤º
            if (result.eventosQR) {
                const qrDisplay = document.getElementById('success-eventos-qr');
                if (qrDisplay) {
                    new QRCode(qrDisplay, {
                        text: result.eventosQR,
                        width: 120,
                        height: 120
                    });
                }
            }
        }

        function closeEventosSuccessDialog() {
            const dialog = document.getElementById('eventos-success-dialog');
            if (dialog) dialog.remove();
            showScanOptions(); // ã‚¹ã‚­ãƒ£ãƒ³ã‚ªãƒ—ã‚·ãƒ§ãƒ³ç”»é¢ã«æˆ»ã‚‹
        }
    </script>

    <!-- Progressive Web App (PWA) ã‚µãƒãƒ¼ãƒˆ -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/service-worker.js').then(function(registration) {
                    console.log('ServiceWorker registration successful');
                }, function(err) {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
    </script>

    <!-- ã‚¢ãƒ—ãƒªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <div id="install-prompt" class="hidden fixed bottom-0 left-0 right-0 bg-white p-4 shadow-lg" style="display: none;">
        <div class="flex justify-between items-center">
            <div>
                <h3 class="font-bold">ã‚¢ãƒ—ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</h3>
                <p class="text-sm text-gray-600">ã‚ˆã‚Šå¿«é©ã«ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã™</p>
            </div>
            <div class="flex space-x-2">
                <button onclick="hideInstallPrompt()" class="px-4 py-2 text-gray-600">å¾Œã§</button>
                <button id="install-button" class="px-4 py-2 bg-blue-600 text-white rounded-lg">ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</button>
            </div>
        </div>
    </div>
</body>

</html>